using ScriptableObj;
using System.Threading;
using Collision;
using StringValues;
using Cysharp.Threading.Tasks;
using System;
using Zenject;

namespace MainHero
{
    public class GettingInvulnerability : IInitializable, IDisposable, ITakebleBoost, IResetableBoost
    {
        private readonly InvulnerabilityConfig _invulnerabilityConfig;
        private readonly GettingDamageCalculation _gettingDamageCalculation;
        private readonly CollidingWithBoost _collidingWithBoost;
        private readonly string _tag;

        private CancellationTokenSource _cts = new CancellationTokenSource();

        public GettingInvulnerability(InvulnerabilityConfig invulnerabilityConfig,
                                      Tags tags,
                                      GettingDamageCalculation gettingDamageCalculation,
                                      CollidingWithBoost collidingWithBoost)
        {
            _invulnerabilityConfig = invulnerabilityConfig;
            _gettingDamageCalculation = gettingDamageCalculation;
            _collidingWithBoost = collidingWithBoost;
            _tag = tags.Invulnerability;
        }

        public void Initialize()
            => _collidingWithBoost.Collided += Take;

        public void Dispose()
        {
            _collidingWithBoost.Collided -= Take;

            _cts.Cancel();
            _cts.Dispose();
        } 

        public void Take(string tag)
        {
            if (tag == _tag)
            {
                _cts.Cancel();
                _cts = new CancellationTokenSource();

                _gettingDamageCalculation.EnabledInvulnerability();
                TimerResetSpeed().Forget();
            }
        }

        public void ResetBoost()
        {
            _cts.Cancel();
            _gettingDamageCalculation.ResetModificator();
        }

        private async UniTask TimerResetSpeed()
        {
            await UniTask.WaitForSeconds(_invulnerabilityConfig.TimeActionInSec, cancellationToken: _cts.Token);
            _gettingDamageCalculation.ResetModificator();
        }
    }
}
